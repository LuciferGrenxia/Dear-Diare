<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>V-Radio Jaehee Edition</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-04@1.0/ChosunGs.css">
    <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBULHjBCarfHTnQ9zFb5DzYXOwtzhjUp7I",
            authDomain: "dear-diare.firebaseapp.com",
            projectId: "dear-diare",
            storageBucket: "dear-diare.firebasestorage.app",
            messagingSenderId: "67882068070",
            appId: "1:67882068070:android:e065d0b90f11a62ffc25a7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const diaryCol = collection(db, "diaries");
        window.db = db;

        const q = query(diaryCol, orderBy("serverTimestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            window.diaries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            render();
        });

        window.postDiary = async () => {
            const input = document.getElementById('diary-input');
            if(!input.value.trim()) return;
            const mode = document.body.className.includes('alastor') ? 'ALASTOR' : (document.body.className.includes('jaehee') ? 'JAEHEE' : 'VOX');
            await addDoc(diaryCol, {
                content: input.value,
                music: document.getElementById('music-input').value,
                author: document.getElementById('post-author').value,
                date: new Date().toLocaleString('ko-KR'),
                serverTimestamp: Date.now(),
                mode: mode,
                isPriv: document.getElementById('post-priv').checked,
                comments: []
            });
            input.value = ''; document.getElementById('music-input').value = ''; document.getElementById('post-priv').checked = false;
        };

        window.saveComments = async (id, comments) => {
            await updateDoc(doc(db, "diaries", id), { comments });
        };

        window.deleteEntry = async (id) => {
            const t = getTheme();
            if(confirm(scripts[t].del)) await deleteDoc(doc(db, "diaries", id));
        };
    </script>

    <style>
        :root { --vox: #00E5FF; --ala: #ff3333; --jae: #FFB6C1; --bg: #050508; }
        * { box-sizing: border-box; }
        body { background: var(--bg); color: white; margin: 0; padding: 15px; transition: 0.3s; word-break: break-all; overflow-x: hidden; font-family: 'Galmuri11', sans-serif; }
        
        /* 폰트 설정 */
        .f-vox { font-family: 'Galmuri11', sans-serif !important; }
        .f-ala { font-family: 'ChosunGs', serif !important; }
        .f-jae { font-family: 'Gamja Flower', cursive !important; }

        .vox-mode { color: var(--vox); }
        .alastor-mode { color: var(--ala); }
        .jaehee-mode { color: var(--jae); }

        #header { border: 2px solid currentColor; padding: 15px; margin-bottom: 20px; background: rgba(0,0,0,0.5); text-align: center; }
        
        .input-section { display: flex; flex-direction: column; gap: 10px; margin-bottom: 30px; }
        select, input, textarea { background: #000; color: inherit; border: 1px solid currentColor; padding: 12px; font-family: inherit; font-size: 0.9rem; outline: none; width: 100%; }
        
        .priv-row { display: flex; align-items: center; gap: 8px; font-size: 0.8rem; padding: 5px 0; }
        .priv-row input { width: 18px; height: 18px; margin: 0; }

        .btn-group { display: flex; gap: 10px; }
        .main-btn { flex: 1; height: 50px; background: transparent; color: inherit; border: 2px solid currentColor; cursor: pointer; font-family: inherit; font-size: 1rem; font-weight: bold; text-transform: uppercase; }

        .entry { border-left: 4px solid currentColor; background: rgba(255,255,255,0.03); padding: 15px; margin-bottom: 25px; }
        .entry-content { font-size: 1.1rem; line-height: 1.6; margin: 12px 0; }
        .locked { filter: blur(12px); opacity: 0.3; pointer-events: none; }

        .action-bar { display: flex; gap: 8px; margin-top: 15px; }
        .icon-btn { flex: 1; height: 38px; background: transparent; border: 1px solid currentColor; color: inherit; cursor: pointer; font-size: 0.75rem; font-family: inherit; }

        .comment-area { margin-top: 15px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; font-size: 0.85rem; }
        .hidden-box { display: none; margin-top: 10px; padding: 10px; border: 1px solid rgba(255,255,255,0.2); }
        
        #preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; padding: 20px; }
    </style>
</head>
<body id="main" class="vox-mode">
    <div id="header">
        <div id="status-text">Ratings are through the roof</div>
        <span style="font-size:1.8rem; font-weight:bold; display:block; margin-top:5px;" id="title-main">Vox</span>
        <span style="font-size:0.9rem; opacity:0.7;" id="title-sub">BROADCAST NETWORK</span>
    </div>

    <div class="input-section">
        <select id="post-author"><option value="Jaehee">Jaehee</option><option value="Vox">Vox</option><option value="Alaster">Alaster</option></select>
        <input type="text" id="music-input" placeholder="Music: Artist - Title">
        <div class="priv-row">
            <input type="checkbox" id="post-priv"> <span>Private Post</span>
        </div>
        <textarea id="diary-input" placeholder="Data input..." rows="4"></textarea>
        <div class="btn-group">
            <button class="main-btn" onclick="postDiary()">TRANSMIT</button>
            <button class="main-btn" onclick="toggleTheme()">SWITCH</button>
        </div>
    </div>

    <div id="feed"></div>

    <div id="preview-modal">
        <img id="preview-img" style="max-width: 100%; border: 1px solid currentColor; margin-bottom: 20px;">
        <button class="main-btn" onclick="closeModal()" style="max-width: 200px;">CLOSE</button>
    </div>

    <script>
        const scripts = {
            vox: { del: "흥, 필요 없는 데이터는 삭제다.\n영구 파기하겠어.", st: "Ratings are through the roof", m: "Vox", s: "BROADCAST NETWORK" },
            ala: { del: "이 즐거운 기록을 정말 파기하실 건가요?\n정말 유감이네요!", st: "A pleasure to meet you", m: "Alastor", s: "THE RADIO DEMON STATION" },
            jae: { del: "기록을 삭제하시겠습니까?", st: "Dear Diary,", m: "Jaehee", s: "PRIVATE CHANNEL" }
        };

        function getTheme() {
            const b = document.body.className;
            return b.includes('alastor') ? 'ala' : (b.includes('jaehee') ? 'jae' : 'vox');
        }

        function render() {
            const feed = document.getElementById('feed');
            if(!window.diaries) return;
            feed.innerHTML = window.diaries.map((d) => `
                <div class="entry ${d.mode === 'ALASTOR' ? 'ala-item f-ala' : (d.mode === 'JAEHEE' ? 'jae-item f-jae' : 'vox-item f-vox')}" id="diary-${d.id}">
                    <div style="font-size:0.75rem; font-weight:bold;">WRITER: ${d.author}</div>
                    <div style="font-size:0.7rem; opacity:0.6; margin-bottom:8px;">${d.mode} CH | ${d.date}</div>
                    ${d.music ? `<div style="font-size:0.8rem; margin-bottom:10px;">♪ ${d.music}</div>` : ''}
                    <div class="entry-content ${d.isPriv ? 'locked' : ''}">${d.isPriv ? 'This content is encrypted.' : d.content}</div>
                    
                    <div class="comment-area">
                        ${(d.comments || []).map((c, ci) => `
                            <div style="margin-bottom:8px;">
                                <b>${c.author}:</b> ${c.text}
                                <button onclick="toggleBox('re-${d.id}-${ci}')" style="background:none; border:none; color:inherit; font-size:0.6rem; cursor:pointer; opacity:0.7;">[Reply]</button>
                                <div id="re-${d.id}-${ci}" class="hidden-box">
                                    <input type="text" id="re-in-${d.id}-${ci}" placeholder="Reply..." style="width:70%; height:30px;">
                                    <button onclick="addReply('${d.id}', ${ci})" style="height:30px; border:1px solid currentColor; background:none; color:inherit;">OK</button>
                                </div>
                                ${(c.replies || []).map(r => `<div style="margin-left:15px; margin-top:4px; font-size:0.8rem; opacity:0.9;">ㄴ <b>${r.author}:</b> ${r.text}</div>`).join('')}
                            </div>
                        `).join('')}
                    </div>

                    <div class="action-bar">
                        <button class="icon-btn" onclick="toggleBox('com-${d.id}')">Comment</button>
                        <button class="icon-btn" onclick="deleteEntry('${d.id}')">Delete</button>
                        <button class="icon-btn" onclick="openCapture('${d.id}')">Save</button>
                    </div>
                    <div id="com-${d.id}" class="hidden-box">
                        <input type="text" id="com-in-${d.id}" placeholder="Comment..." style="width:75%;">
                        <button onclick="addComment('${d.id}')" style="height:35px; border:1px solid currentColor; background:none; color:inherit;">OK</button>
                    </div>
                </div>
            `).join('');
        }

        window.addComment = async (id) => {
            const text = document.getElementById(`com-in-${id}`).value;
            if(!text.trim()) return;
            const entry = window.diaries.find(d => d.id === id);
            const comments = [...(entry.comments || []), { author: document.getElementById('post-author').value, text, replies: [] }];
            await window.saveComments(id, comments);
        };

        window.addReply = async (id, ci) => {
            const text = document.getElementById(`re-in-${id}-${ci}`).value;
            if(!text.trim()) return;
            const entry = window.diaries.find(d => d.id === id);
            if(!entry.comments[ci].replies) entry.comments[ci].replies = [];
            entry.comments[ci].replies.push({ author: document.getElementById('post-author').value, text });
            await window.saveComments(id, entry.comments);
        };

        window.toggleTheme = () => {
            const b = document.body;
            const h = (id) => {
                const s = scripts[id];
                document.getElementById('status-text').innerText = s.st;
                document.getElementById('title-main').innerText = s.m;
                document.getElementById('title-sub').innerText = s.s;
            };
            if(b.classList.contains('vox-mode')) { b.className = 'alastor-mode'; h('ala'); }
            else if(b.classList.contains('alastor-mode')) { b.className = 'jaehee-mode'; h('jae'); }
            else { b.className = 'vox-mode'; h('vox'); }
            render();
        };

        window.toggleBox = (id) => { const b = document.getElementById(id); b.style.display = b.style.display === 'block' ? 'none' : 'block'; };
        window.openCapture = (id) => {
            const target = document.getElementById(`diary-${id}`);
            target.classList.add('capturing');
            html2canvas(target, { backgroundColor: '#050508', scale: 2 }).then(canvas => {
                target.classList.remove('capturing');
                document.getElementById('preview-img').src = canvas.toDataURL();
                document.getElementById('preview-modal').style.display = 'flex';
            });
        };
        window.closeModal = () => document.getElementById('preview-modal').style.display = 'none';
    </script>
</body>
</html>
