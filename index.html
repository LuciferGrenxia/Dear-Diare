<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>V-Radio Jaehee Edition</title>
    <meta name="robots" content="noindex, nofollow">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/galmuri@latest/dist/galmuri.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_20-04@1.0/ChosunGs.css">
    <link href="https://fonts.googleapis.com/css2?family=Gamja+Flower&display=swap" rel="stylesheet">
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, addDoc, query, orderBy, onSnapshot, doc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBULHjBCarfHTnQ9zFb5DzYXOwtzhjUp7I",
            authDomain: "dear-diare.firebaseapp.com",
            projectId: "dear-diare",
            storageBucket: "dear-diare.firebasestorage.app",
            messagingSenderId: "67882068070",
            appId: "1:67882068070:android:e065d0b90f11a62ffc25a7"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const diaryCol = collection(db, "diaries");

        const q = query(diaryCol, orderBy("serverTimestamp", "desc"));
        onSnapshot(q, (snapshot) => {
            window.diaries = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            render(); 
        });

        window.postDiary = async () => {
            const input = document.getElementById('diary-input');
            if(!input.value.trim()) return;
            const bodyClass = document.body.className;
            const mode = bodyClass.includes('alastor') ? 'ALASTOR' : (bodyClass.includes('jaehee') ? 'JAEHEE' : 'VOX');
            
            await addDoc(diaryCol, {
                content: input.value,
                music: document.getElementById('music-input').value,
                author: document.getElementById('post-author').value,
                date: new Date().toLocaleString('ko-KR'),
                serverTimestamp: Date.now(),
                mode: mode,
                isPriv: document.getElementById('post-priv').checked,
                comments: []
            });
            input.value = ''; document.getElementById('post-priv').checked = false;
        };

        window.dbUpdate = async (id, data) => { await updateDoc(doc(db, "diaries", id), data); };
        window.dbDelete = async (id) => { await deleteDoc(doc(db, "diaries", id)); };
    </script>

    <style>
        :root { --vox: #00E5FF; --ala: #ff3333; --jae: #FFB6C1; --bg: #050508; }
        body { background: var(--bg); color: white; margin: 0; padding: 20px; transition: 0.3s; word-break: break-all; overflow-x: hidden; }
        
        .f-vox { font-family: 'Galmuri11', sans-serif !important; }
        .f-ala { font-family: 'ChosunGs', serif !important; }
        .f-jae { font-family: 'Gamja Flower', cursive !important; }

        .vox-mode { color: var(--vox); font-family: 'Galmuri11', sans-serif; }
        .alastor-mode { color: var(--ala); font-family: 'ChosunGs', serif; }
        .jaehee-mode { color: var(--jae); font-family: 'Gamja Flower', cursive; }

        /* 게시물 개별 고정 스타일 */
        .vox-item { color: var(--vox) !important; border-left-color: var(--vox) !important; font-family: 'Galmuri11', sans-serif !important; }
        .ala-item { color: var(--ala) !important; border-left-color: var(--ala) !important; font-family: 'ChosunGs', serif !important; }
        .jae-item { color: var(--jae) !important; border-left-color: var(--jae) !important; font-family: 'Gamja Flower', cursive !important; }

        #header { border: 2px solid var(--vox); padding: 15px; margin-bottom: 25px; background: rgba(0,0,0,0.5); text-align: center; }
        .alastor-mode #header { border-color: var(--ala); }
        .jaehee-mode #header { border-color: var(--jae); }
        .input-section { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
        .filter-row { display: flex; gap: 4px; margin-bottom: 10px; width: 100%; box-sizing: border-box; }
        .filter-row select { flex: 1; min-width: 0; background: #000; color: #fff; border: 1px solid #444; padding: 5px 2px; font-family: inherit; font-size: 0.7rem; outline: none; }
        select, input, textarea { background: #000; color: #fff; border: 1px solid #444; padding: 8px; font-family: inherit; font-size: 0.8rem; outline: none; width: 100%; box-sizing: border-box; }
        .main-btn { height: 45px; background: transparent; color: inherit; border: 2px solid currentColor; cursor: pointer; font-family: inherit; font-size: 1rem; font-weight: bold; margin-top: 5px; text-transform: uppercase; }
        .entry { border-left: 4px solid currentColor; background: rgba(255,255,255,0.02); padding: 15px; margin-bottom: 20px; position: relative; }
        .smart-priv-btn { position: absolute; top: 10px; right: 10px; background: transparent; border: 1px solid currentColor; color: inherit; font-size: 0.6rem; cursor: pointer; padding: 3px 8px; font-family: inherit; }
        
        .entry-content { font-size: 1.2rem; line-height: 1.5; margin: 8px 0; padding: 5px; outline: none; transition: 0.3s; }
        .locked { filter: blur(10px); opacity: 0.5; pointer-events: none; user-select: none; }

        .comment-area { margin: 12px 0; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 10px; font-size: 0.85rem; }
        .hidden-box { display: none; margin: 8px 0; border: 1px solid rgba(255,255,255,0.2); padding: 8px; }
        .input-row { display: flex; gap: 4px; align-items: center; width: 100%; }
        .ok-btn { width: 45px; height: 32px; background: transparent; border: 1px solid currentColor; color: inherit; font-size: 0.65rem; cursor: pointer; flex-shrink: 0; }
        .action-bar { display: flex; flex-direction: column; gap: 5px; margin-top: 12px; }
        .btn-row { display: flex; gap: 5px; }
        .icon-btn { flex: 1; height: 35px; background: transparent; border: 1px solid currentColor; color: inherit; cursor: pointer; font-family: inherit; font-size: 0.65rem; font-weight: bold; white-space: nowrap; }
        #custom-prompt { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 25px; z-index: 4000; text-align: center; border: 2px solid currentColor; background: #000; min-width: 280px; box-sizing: border-box; }
        .p-vox { border-color: var(--vox) !important; color: var(--vox) !important; font-family: 'Galmuri11', sans-serif !important; box-shadow: 0 0 15px var(--vox); }
        .p-ala { border-color: var(--ala) !important; color: var(--ala) !important; font-family: 'ChosunGs', serif !important; text-shadow: 0 0 3px var(--ala); }
        .p-jae { border-color: var(--jae) !important; color: var(--jae) !important; font-family: 'Gamja Flower', cursive !important; background: #fff !important; }
        #preview-modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 1000; justify-content: center; align-items: center; flex-direction: column; padding: 20px; }
        .capturing .action-bar, .capturing .smart-priv-btn, .capturing .hidden-box, .capturing button { display: none !important; }
    </style>
</head>
<body id="main" class="vox-mode">
    <div id="header">
        <div id="status-text">Ratings are through the roof</div>
        <span style="font-size:1.8rem; font-weight:bold; display:block; margin-top:5px;" id="title-main">Vox</span>
        <span style="font-size:0.9rem; opacity:0.7;" id="title-sub">BROADCAST NETWORK</span>
    </div>

    <div id="custom-prompt">
        <p id="prompt-msg" style="margin-bottom:15px; font-size:0.9rem; line-height:1.4; white-space: pre-wrap;"></p>
        <textarea id="prompt-area" style="display:none; width:100%; height:80px; margin-bottom:15px; background:#000; color:inherit; border:1px solid currentColor; font-family:inherit;"></textarea>
        <input type="password" id="prompt-input" style="margin-bottom:15px; display:none; width:100%; text-align:center;">
        <div id="prompt-btns" style="display:flex; gap:10px; justify-content:center;">
            <button class="icon-btn" id="prompt-ok">OK</button>
            <button class="icon-btn" id="prompt-cancel" onclick="closePrompt()">CANCEL</button>
        </div>
    </div>

    <div id="preview-modal">
        <img id="preview-img" style="max-width: 100%; max-height: 75%; border: 1px solid currentColor; margin-bottom: 20px;">
        <div style="display: flex; gap: 10px; width: 100%; height: 45px;">
            <button class="main-btn" id="download-trigger" style="flex: 2; margin-top:0;">갤러리 저장</button>
            <button class="main-btn" onclick="closeModal()" style="flex: 1; border-color: #555; margin-top:0;">닫기</button>
        </div>
    </div>

    <div class="input-section">
        <div class="filter-row">
            <select id="post-author"><option value="Jaehee">Jaehee</option><option value="Vox">Vox</option><option value="Alastor">Alastor</option></select>
            <select id="filter-author" onchange="render()"><option value="ALL">All Users</option><option value="Jaehee">Jaehee</option><option value="Vox">Vox</option><option value="Alastor">Alastor</option></select>
            <select id="filter-year" onchange="render()"><option value="ALL">Year</option><option value="2026">2026</option><option value="2025">2025</option></select>
            <select id="filter-month" onchange="render()"><option value="ALL">Month</option><option value="1">1</option><option value="2">2</option><option value="12">12</option></select>
        </div>
        <div style="display: flex; gap: 8px; align-items: center; width:100%; box-sizing:border-box;">
            <input type="text" id="music-input" placeholder="Music: Artist - Title" style="flex:1;">
            <div style="display:flex; align-items:center; gap:4px; font-size:0.7rem; white-space:nowrap; padding-right:5px;">
                <input type="checkbox" id="post-priv" style="width:14px; height:14px; margin:0;"> Priv
            </div>
        </div>
        <textarea id="diary-input" placeholder="Data input..."></textarea>
        <button class="main-btn" onclick="postDiary()">TRANSMIT</button>
        <button class="main-btn" onclick="toggleTheme()">SWITCH MODE</button>
    </div>

    <div id="feed"></div>

    <script>
        const PW = "1206";
        const scripts = {
            vox: { lock: "내 시스템에 접근하겠다고?\n좋아, 암호를 대봐.", wrong: "하! 이 멍청한 놈.\n암호가 틀렸잖아.", del: "흥, 필요 없는 데이터는 삭제다.\n영구 파기하겠어.", edit: "로그를 수정하나?\n이번엔 좀 더 완벽하게 기록해봐.", copy: "완벽하게 수신했어!" },
            ala: { lock: "유쾌한 비밀을 숨기시려나요?\n어디, 암호를 적어보시죠.", wrong: "오, 이런! 유감스러운 오답이군요.\n다시 시도해보세요!", del: "이 즐거운 기록을 정말 파기하실 건가요?\n정말 유감이네요!", edit: "문구를 고치시는군요.\n조금 더 품위 있게 부탁드려요.", copy: "정말 유쾌한 서신이군요!" },
            jae: { lock: "비밀번호를 입력하세요.", wrong: "암호가 틀렸습니다.", del: "기록을 삭제하시겠습니까?", edit: "내용을 수정합니다.", copy: "일기장에게." }
        };

        function render() {
            if(!window.diaries) return;
            const authF = document.getElementById('filter-author').value;
            const yearF = document.getElementById('filter-year').value;
            const monthF = document.getElementById('filter-month').value;
            const feed = document.getElementById('feed');

            feed.innerHTML = window.diaries
                .filter(d => authF === 'ALL' || d.author === authF)
                .filter(d => yearF === 'ALL' || d.date.includes(yearF))
                .filter(d => monthF === 'ALL' || d.date.split('.')[1]?.trim() === monthF)
                .map((d) => `
                <div class="entry ${getEntryClass(d.mode)}" id="diary-${d.id}">
                    <button class="smart-priv-btn" onclick="handlePriv('${d.id}')">${d.isPriv ? 'Unlock' : 'Priv'}</button>
                    <div class="author-info">WRITER: ${d.author} ${d.isPriv ? '(Private)' : ''}</div>
                    <div style="font-size:0.7rem; opacity:0.6; margin-bottom:5px;">${d.mode} CH | ${d.date}</div>
                    ${d.music ? `<div style="font-size:0.7rem; margin-bottom:8px;">♪ ${d.music}</div>` : ''}
                    <div id="content-${d.id}" class="entry-content ${d.isPriv ? 'locked' : ''}">${d.content}</div>
                    <div class="comment-area">
                        ${(d.comments || []).map((c, ci) => `
                            <div class="comment-item">
                                <b>${c.author}:</b> <span>${c.text}</span>
                                <button onclick="toggleBox('re-${d.id}-${ci}')" style="background:none; border:none; color:inherit; font-size:0.6rem; cursor:pointer;">[Reply]</button>
                                <button onclick="openPrompt('editComment', '${d.id}', ${ci})" style="background:none; border:none; color:inherit; font-size:0.6rem; cursor:pointer;">[Edit]</button>
                                <button onclick="openPrompt('deleteComment', '${d.id}', ${ci})" style="background:none; border:none; color:inherit; font-size:0.6rem; cursor:pointer;">[Del]</button>
                                <div id="re-${d.id}-${ci}" class="hidden-box">
                                    <div class="input-row">
                                        <select id="re-au-${d.id}-${ci}" style="width:65px; font-size:0.6rem;"><option value="Jaehee">Jaehee</option><option value="Vox">Vox</option><option value="Alastor">Alastor</option></select>
                                        <input type="text" id="re-in-${d.id}-${ci}" placeholder="Reply..." style="font-size:0.7rem;" onkeypress="if(event.keyCode==13) addReply('${d.id}', ${ci})">
                                        <button class="ok-btn" onclick="addReply('${d.id}', ${ci})">OK</button>
                                    </div>
                                </div>
                                ${(c.replies || []).map((r, ri) => `
                                    <div class="reply-item">ㄴ <b>${r.author}:</b> <span>${r.text}</span>
                                        <button onclick="toggleBox('rr-${d.id}-${ci}-${ri}')" style="background:none; border:none; color:inherit; font-size:0.6rem; cursor:pointer;">[Reply]</button>
                                        <button onclick="openPrompt('editReply', '${d.id}', ${ci}, ${ri})" style="background:none; border:none; color:inherit; font-size:0.6rem; cursor:pointer;">[Edit]</button>
                                        <button onclick="openPrompt('deleteReply', '${d.id}', ${ci}, ${ri})" style="background:none; border:none; color:inherit; font-size:0.6rem; cursor:pointer;">[Del]</button>
                                        <div id="rr-${d.id}-${ci}-${ri}" class="hidden-box">
                                            <div class="input-row">
                                                <select id="rr-au-${d.id}-${ci}-${ri}" style="width:65px; font-size:0.6rem;"><option value="Jaehee">Jaehee</option><option value="Vox">Vox</option><option value="Alastor">Alastor</option></select>
                                                <input type="text" id="rr-in-${d.id}-${ci}-${ri}" placeholder="To Reply..." style="font-size:0.7rem;" onkeypress="if(event.keyCode==13) addReReply('${d.id}', ${ci}, ${ri})">
                                                <button class="ok-btn" onclick="addReReply('${d.id}', ${ci}, ${ri})">OK</button>
                                            </div>
                                        </div>
                                        ${(r.reReplies || []).map((rr, rri) => `
                                            <div class="re-reply-item">↳ <b>${rr.author}:</b> <span>${rr.text}</span>
                                            <button onclick="openPrompt('editReReply', '${d.id}', ${ci}, ${ri}, ${rri})" style="background:none; border:none; color:inherit; font-size:0.6rem; cursor:pointer;">[Edit]</button>
                                            <button onclick="openPrompt('deleteReReply', '${d.id}', ${ci}, ${ri}, ${rri})" style="background:none; border:none; color:inherit; font-size:0.6rem; cursor:pointer;">[Del]</button></div>
                                        `).join('')}
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>
                    <div class="action-bar">
                        <div class="btn-row">
                            <button class="icon-btn" onclick="broadcast('${d.id}')">Broadcast</button>
                            <button class="icon-btn" onclick="openPrompt('edit', '${d.id}')">Edit</button>
                            <button class="icon-btn" onclick="toggleBox('com-${d.id}')">Comment</button>
                            <button class="icon-btn" onclick="openPrompt('delete', '${d.id}')">Delete</button>
                        </div>
                        <button class="icon-btn" style="width:100%; margin-top:5px; height:40px;" onclick="openCapture('${d.id}', '${d.author}', '${d.date}')">Save Image to Gallery</button>
                    </div>
                    <div id="com-${d.id}" class="hidden-box">
                        <div class="input-row">
                            <select id="com-au-${d.id}" style="width:65px; font-size:0.6rem;"><option value="Jaehee">Jaehee</option><option value="Vox">Vox</option><option value="Alastor">Alastor</option></select>
                            <input type="text" id="com-in-${d.id}" placeholder="Comment..." style="font-size:0.7rem;" onkeypress="if(event.keyCode==13) addComment('${d.id}')">
                            <button class="ok-btn" onclick="addComment('${d.id}')">OK</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function getEntryClass(m) {
            if(m === 'ALASTOR') return 'ala-item';
            if(m === 'JAEHEE') return 'jae-item';
            return 'vox-item';
        }

        function openPrompt(type, id, ci, ri, rri) {
            const d = window.diaries.find(x => x.id === id);
            const t = d.mode.toLowerCase().slice(0,3);
            const modal = document.getElementById('custom-prompt');
            const msg = document.getElementById('prompt-msg');
            const input = document.getElementById('prompt-input');
            const area = document.getElementById('prompt-area');
            const cancelBtn = document.getElementById('prompt-cancel');
            
            modal.style.display = 'block';
            modal.className = d.mode === 'ALASTOR' ? 'p-ala' : (d.mode === 'JAEHEE' ? 'p-jae' : 'p-vox');
            input.style.display = (type.includes('unlock') || type.includes('priv') ? 'block' : 'none');
            area.style.display = (type.includes('edit') ? 'block' : 'none');
            cancelBtn.style.display = (type === 'copy' ? 'none' : 'block');
            input.value = '';

            if(type === 'copy') msg.innerText = scripts[t].copy;
            else if(type.includes('del')) msg.innerText = scripts[t].del;
            else if(type.includes('edit')) {
                msg.innerText = scripts[t].edit;
                if(type === 'edit') area.value = d.content;
                else if(type === 'editComment') area.value = d.comments[ci].text;
                else if(type === 'editReply') area.value = d.comments[ci].replies[ri].text;
                else if(type === 'editReReply') area.value = d.comments[ci].replies[ri].reReplies[rri].text;
            } else msg.innerText = scripts[t].lock;

            document.getElementById('prompt-ok').onclick = async () => {
                if(type === 'copy') closePrompt();
                else if(type.includes('delete')) {
                    if(type === 'delete') await dbDelete(id);
                    else if(type === 'deleteComment') { d.comments.splice(ci, 1); await dbUpdate(id, { comments: d.comments }); }
                    else if(type === 'deleteReply') { d.comments[ci].replies.splice(ri, 1); await dbUpdate(id, { comments: d.comments }); }
                    else if(type === 'deleteReReply') { d.comments[ci].replies[ri].reReplies.splice(rri, 1); await dbUpdate(id, { comments: d.comments }); }
                    closePrompt();
                } else if(type.includes('edit')) {
                    const newVal = area.value;
                    if(type === 'edit') await dbUpdate(id, { content: newVal });
                    else if(type === 'editComment') { d.comments[ci].text = newVal; await dbUpdate(id, { comments: d.comments }); }
                    else if(type === 'editReply') { d.comments[ci].replies[ri].text = newVal; await dbUpdate(id, { comments: d.comments }); }
                    else if(type === 'editReReply') { d.comments[ci].replies[ri].reReplies[rri].text = newVal; await dbUpdate(id, { comments: d.comments }); }
                    closePrompt();
                } else if(input.value === PW) {
                    await dbUpdate(id, { isPriv: (type === 'priv') });
                    closePrompt();
                } else alert(scripts[t].wrong);
            };
        }

        function handlePriv(id) { const d = window.diaries.find(x => x.id === id); if(d.isPriv) openPrompt('unlock', id); else openPrompt('priv', id); }
        function closePrompt() { document.getElementById('custom-prompt').style.display = 'none'; }
        function broadcast(id) {
            const d = window.diaries.find(x => x.id === id);
            const toWho = d.mode === 'ALASTOR' ? "Radio Demon Station" : "Vox Broadcast Network";
            const comms = (d.comments || []).map(c => `[Comment] ${c.author}: ${c.text}`).join('\n');
            const fullText = `[Date/Time] ${d.date}\n[Writer] ${d.author}\n[To] ${toWho}\n[Content]\n${d.content}\n${comms}`;
            navigator.clipboard.writeText(fullText).then(() => openPrompt('copy', id));
        }
        function toggleTheme() {
            const body = document.body;
            if(body.classList.contains('vox-mode')) { body.className = 'alastor-mode'; updateHeader("A pleasure to meet you", "Alastor", "THE RADIO DEMON STATION"); }
            else if(body.classList.contains('alastor-mode')) { body.className = 'jaehee-mode'; updateHeader("Dear Diary,", "Jaehee", "PRIVATE CHANNEL"); }
            else { body.className = 'vox-mode'; updateHeader("Ratings are through the roof", "Vox", "BROADCAST NETWORK"); }
            render();
        }
        function updateHeader(st, m, s) { document.getElementById('status-text').innerText = st; document.getElementById('title-main').innerText = m; document.getElementById('title-sub').innerText = s; }
        function openCapture(id, author, date) { const target = document.getElementById(`diary-${id}`); target.classList.add('capturing'); html2canvas(target, { backgroundColor: '#050508', scale: 2 }).then(canvas => { target.classList.remove('capturing'); const modal = document.getElementById('preview-modal'); document.getElementById('preview-img').src = canvas.toDataURL(); modal.style.display = 'flex'; document.getElementById('download-trigger').onclick = () => { const link = document.createElement('a'); link.download = `${author}_${date.replace(/[^0-9]/g,'_')}.png`; link.href = canvas.toDataURL(); link.click(); }; }); }
        function closeModal() { document.getElementById('preview-modal').style.display = 'none'; }
        function toggleBox(id) { const box = document.getElementById(id); box.style.display = (box.style.display === 'block') ? 'none' : 'block'; }
        async function addComment(id) { const d = window.diaries.find(x => x.id === id); const auth = document.getElementById(`com-au-${id}`).value; const text = document.getElementById(`com-in-${id}`).value; if(!text.trim()) return; const newComments = [...(d.comments || []), { author: auth, text: text, replies: [] }]; await dbUpdate(id, { comments: newComments }); }
        async function addReply(id, ci) { const d = window.diaries.find(x => x.id === id); const auth = document.getElementById(`re-au-${id}-${ci}`).value; const text = document.getElementById(`re-in-${id}-${ci}`).value; if(!text.trim()) return; if(!d.comments[ci].replies) d.comments[ci].replies = []; d.comments[ci].replies.push({ author: auth, text: text, reReplies: [] }); await dbUpdate(id, { comments: d.comments }); }
        async function addReReply(id, ci, ri) { const d = window.diaries.find(x => x.id === id); const auth = document.getElementById(`rr-au-${id}-${ci}-${ri}`).value; const text = document.getElementById('rr-in-'+id+'-'+ci+'-'+ri).value; if(!text.trim()) return; d.comments[ci].replies[ri].reReplies.push({ author: auth, text: text }); await dbUpdate(id, { comments: d.comments }); }
    </script>
</body>
</html>
